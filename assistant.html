<script>
  const chatArea = document.getElementById('chatArea');
  const chatInput = document.getElementById('chatInput');
  const sendBtn   = document.getElementById('sendBtn');

  // آدرس Webhook چت شما در n8n
  const chatWebhookUrl = 'https://n8n-render-1-xacg.onrender.com/webhook/ai-chat';

  // تابع اضافه کردن پیام
  function addMessage(text, sender) {
    const wrap = document.createElement('div');
    wrap.classList.add('message', sender);
    const bubble = document.createElement('div');
    bubble.classList.add('bubble', sender);
    bubble.textContent = text;
    wrap.appendChild(bubble);
    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  // ارسال پیام کاربر
  sendBtn.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (!text) return;
    addMessage(text, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;

    // نمایش اسپینر تا دریافت پاسخ
    const loader = document.createElement('div');
    loader.classList.add('spinner-border','text-secondary');
    sendBtn.innerHTML = 'در حال ارسال <span></span>';
    sendBtn.querySelector('span').appendChild(loader);

    // فراخوانی Webhook
    fetch(chatWebhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    })
    .then(res => {
      if (!res.ok) throw new Error(`Status ${res.status}`);
      return res.json();
    })
    .then(data => {
      // توجه: اینجا فیلد 'output' را باید بخوانیم
      addMessage(data.output || '(پاسخی دریافت نشد)', 'assistant');
    })
    .catch(err => {
      console.error(err);
      addMessage('خطا در ارتباط با سرور؛ لطفاً بعداً تلاش کنید.', 'assistant');
    })
    .finally(() => {
      sendBtn.disabled = false;
      sendBtn.textContent = 'ارسال';
    });
  });

  // قابلیت ارسال با کلید Enter + Ctrl
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      sendBtn.click();
    }
  });
</script>
